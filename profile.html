<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>الملف الشخصي</title>
  <style>
    /* تصميم مودرن */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 0 20px 40px;
      color: #333;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      border-bottom: 1px solid #ddd;
    }
    header h1 {
      font-weight: 700;
      font-size: 1.6rem;
    }
    #logout-btn {
      background-color: #e74c3c;
      border: none;
      color: white;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #logout-btn:hover {
      background-color: #c0392b;
    }
    main {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 12px;
      padding: 25px 30px;
      box-shadow: 0 5px 15px rgb(0 0 0 / 0.1);
    }
    .profile-section {
      text-align: center;
      margin-bottom: 30px;
    }
    .profile-emoji {
      font-size: 64px;
      margin: 15px 0;
      display: inline-block;
      border-radius: 50%;
      background: #f0f0f0;
      width: 90px;
      height: 90px;
      line-height: 90px;
    }
    p {
      margin: 8px 0;
      font-size: 1.1rem;
    }
    button, input, select, textarea {
      font-family: inherit;
    }
    button {
      background-color: #3498db;
      border: none;
      color: white;
      padding: 10px 18px;
      margin-top: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #2980b9;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px 10px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
      box-sizing: border-box;
      resize: vertical;
    }
    h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 6px;
      font-weight: 700;
    }
    #emoji-store {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .emoji-btn {
      font-size: 28px;
      padding: 8px 15px;
      border-radius: 8px;
      border: 2px solid #3498db;
      background-color: white;
      cursor: pointer;
      transition: background-color 0.3s ease, border-color 0.3s ease;
      min-width: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .emoji-btn.owned {
      border-color: #27ae60;
      background-color: #d4f5d4;
      color: #27ae60;
      font-weight: 700;
    }
    ul {
      list-style: none;
      padding: 0;
      background: #f9f9f9;
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: inset 0 0 10px #ccc;
    }
    li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      font-size: 1rem;
    }
    li:last-child {
      border-bottom: none;
    }
  </style>
</head>
<body>

  <header>
    <h1>الملف الشخصي</h1>
    <button id="logout-btn">تسجيل خروج</button>
  </header>

  <main>
    <section class="profile-section">
      <p>مرحبًا يا <strong><span id="user-email"></span></strong></p>
      <div id="profile-emoji" class="profile-emoji">👤</div>
      <p>UID: <span id="user-uid"></span></p>
      <p>نقاطك: <span id="user-points">0</span></p>
      <button id="add-point">اضغط هنا لكسب نقطة</button>
    </section>

    <section>
      <h2>🛍️ المتجر</h2>
      <div id="emoji-store"></div>
    </section>

    <section>
      <h2>🧑‍🤝‍🧑 أضف صديقًا</h2>
      <input type="text" id="friend-uid-input" placeholder="ادخل UID الصديق" />
      <button id="add-friend-btn">➕ إضافة صديق</button>

      <h2>👥 قائمة أصدقائك</h2>
      <ul id="friends-list"></ul>
    </section>

    <section>
      <h2>📨 إرسال رسالة</h2>
      <select id="friend-select"></select>
      <textarea id="message-input" rows="3" placeholder="اكتب رسالتك هنا..."></textarea>
      <button id="send-message-btn">✉️ إرسال</button>

      <h2>📬 رسائلك الواردة</h2>
      <ul id="inbox"></ul>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, increment, collection, addDoc, query, where, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDvMLI4QL90kIbjVn_6e02dUIa4K1dt3Ws",
      authDomain: "login-c8afc.firebaseapp.com",
      projectId: "login-c8afc",
      appId: "1:907378152010:web:587c0777c4926b0ba0ccb3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const emailSpan = document.getElementById("user-email");
    const uidSpan = document.getElementById("user-uid");
    const pointsSpan = document.getElementById("user-points");
    const profileEmojiSpan = document.getElementById("profile-emoji");
    const addPointBtn = document.getElementById("add-point");
    const logoutBtn = document.getElementById("logout-btn");

    let user;

    const emojis = [
      { id: "smile", emoji: "😊", cost: 5 },
      { id: "cool", emoji: "😎", cost: 10 },
      { id: "star", emoji: "⭐", cost: 15 },
      { id: "fire", emoji: "🔥", cost: 20 }
    ];

    onAuthStateChanged(auth, async (_user) => {
      if (_user) {
        user = _user;
        emailSpan.textContent = user.email;
        uidSpan.textContent = user.uid;

        const userRef = doc(db, "users", user.uid);
        let userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          await setDoc(userRef, {
            email: user.email,
            name: user.displayName,
            points: 0,
            ownedEmojis: [],
            profileEmoji: "",
            friends: []
          });
          userSnap = await getDoc(userRef);
        }

        const data = userSnap.data();
        pointsSpan.textContent = data.points;
        profileEmojiSpan.textContent = data.profileEmoji || "👤";

        addPointBtn.onclick = async () => {
          pointsSpan.textContent = parseInt(pointsSpan.textContent) + 1;
          await updateDoc(userRef, { points: increment(1) });
        };

        // المتجر
        const storeDiv = document.getElementById("emoji-store");
        const owned = data.ownedEmojis || [];

        storeDiv.innerHTML = ""; // تنظيف المحتوى

        emojis.forEach((item) => {
          const btn = document.createElement("button");
          btn.textContent = item.emoji + ` (${item.cost} نقطة)`;
          btn.className = "emoji-btn";
          if (owned.includes(item.id)) {
            btn.classList.add("owned");
            btn.textContent = `✅ ${item.emoji}`;
            btn.onclick = async () => {
              await updateDoc(userRef, { profileEmoji: item.emoji });
              profileEmojiSpan.textContent = item.emoji;
              alert("✅ تم تعيين الإيموجي كصورة بروفايل");
            };
          } else {
            btn.onclick = async () => {
              const currentPoints = parseInt(pointsSpan.textContent);
              if (currentPoints >= item.cost) {
                await updateDoc(userRef, {
                  points: currentPoints - item.cost,
                  ownedEmojis: [...owned, item.id]
                });
                alert("✅ تم الشراء! أعد تحميل الصفحة");
              } else {
                alert("❌ لا تملك نقاط كافية");
              }
            };
          }
          storeDiv.appendChild(btn);
        });

        // أصدقاء
        const friendInput = document.getElementById("friend-uid-input");
        const addFriendBtn = document.getElementById("add-friend-btn");
        const friendsList = document.getElementById("friends-list");

        addFriendBtn.onclick = async () => {
          const friendUid = friendInput.value.trim();
          if (!friendUid || friendUid === user.uid) return alert("❌ UID غير صالح");

          const friendDoc = await getDoc(doc(db, "users", friendUid));
          if (!friendDoc.exists()) return alert("❌ المستخدم غير موجود");

          let currentFriends = (await getDoc(userRef)).data().friends || [];
          if (currentFriends.includes(friendUid)) return alert("✅ الصديق مضاف بالفعل");

          currentFriends.push(friendUid);
          await updateDoc(userRef, { friends: currentFriends });
          alert("✅ تم الإضافة");
          friendInput.value = "";
          loadFriends();
          loadFriendSelect();
        };

        async function loadFriends() {
          const friends = (await getDoc(userRef)).data().friends || [];
          friendsList.innerHTML = "";
          for (let fid of friends) {
            const friendSnap = await getDoc(doc(db, "users", fid));
            if (friendSnap.exists()) {
              const li = document.createElement("li");
              li.textContent = `${friendSnap.data().name || "مستخدم"} (${friendSnap.data().email})`;
              friendsList.appendChild(li);
            }
          }
        }

        // إرسال رسالة
        const messageInput = document.getElementById("message-input");
        const sendMessageBtn = document.getElementById("send-message-btn");
        const friendSelect = document.getElementById("friend-select");
        const inbox = document.getElementById("inbox");

        sendMessageBtn.onclick = async () => {
          const message = messageInput.value.trim();
          const toUid = friendSelect.value;
          if (!message || !toUid) return alert("❌ الرجاء اختيار صديق وكتابة رسالة");

          await addDoc(collection(db, "messages"), {
            from: user.uid,
            to: toUid,
            message,
            timestamp: Timestamp.now()
          });
          messageInput.value = "";
          alert("✅ تم إرسال الرسالة");
        };

        async function loadFriendSelect() {
          const friends = (await getDoc(userRef)).data().friends || [];
          friendSelect.innerHTML = "<option value=''>اختر صديق</option>";
          for (let fid of friends) {
            const friendSnap = await getDoc(doc(db, "users", fid));
            if (friendSnap.exists()) {
              const option = document.createElement("option");
              option.value = fid;
              option.textContent = friendSnap.data().name || fid;
              friendSelect.appendChild(option);
            }
          }
        }

        // تحميل الرسائل الواردة (Inbox)
        function loadInbox() {
          const q = query(collection(db, "messages"), where("to", "==", user.uid));
          onSnapshot(q, (snapshot) => {
            inbox.innerHTML = "";
            snapshot.forEach(doc => {
              const msg = doc.data();
              const li = document.createElement("li");
              li.textContent = `من ${msg.from}: ${msg.message}`;
              inbox.appendChild(li);
            });
          });
        }

        // بداية التحميل
        await loadFriends();
        await loadFriendSelect();
        loadInbox();

      } else {
        window.location.href = "index.html";
      }
    });

    logoutBtn.onclick = () => {
      signOut(auth);
    };
  </script>
</body>
</html>
